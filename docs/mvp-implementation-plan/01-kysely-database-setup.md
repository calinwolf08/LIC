# Step 01: Kysely Database Setup

## Overview
Set up Kysely as the TypeScript type-safe SQL query builder for SQLite database operations. This provides a solid foundation for all database interactions with compile-time type checking and excellent IDE support.

## Dependencies
- ✅ SQLite database file already exists (`sqlite.db`)
- ✅ better-sqlite3 already installed

## Requirements

### Package Installation
Install required packages:
- `kysely` - Type-safe SQL query builder
- `kysely-codegen` (dev) - Generate TypeScript types from database schema

### Database Connection
Create a singleton database instance that:
- Uses better-sqlite3 driver
- Configures connection pooling (if needed)
- Exports typed database instance for use throughout the app
- Handles graceful shutdown

### Migration System
Set up Kysely migrations:
- Create migration directory structure
- Configure migration runner
- Create initial migration placeholder (actual schema in Step 02)
- Add migration scripts to package.json

### Type Generation
Configure automatic type generation:
- Setup kysely-codegen to generate types from database
- Create types that reflect actual database schema
- Ensure types update when schema changes

## Implementation Details

### File Structure
```
/src/lib/db/
├── index.ts                    # Database instance export
├── connection.ts               # Database connection setup
├── types.ts                    # Generated database types (auto-generated)
└── migrations/
    ├── index.ts                # Migration runner
    └── (migrations added in Step 02)
```

### Key Files to Create

#### 1. `/src/lib/db/connection.ts`
```typescript
/**
 * Database connection setup using Kysely with better-sqlite3
 *
 * Exports:
 * - createDB(): Creates and configures database instance
 * - db: Singleton database instance
 */
```

**Requirements:**
- Import Kysely and SQLiteDialect
- Import better-sqlite3 Database
- Create typed database instance with proper dialect
- Configure WAL mode for better concurrency
- Export singleton instance

**Functions:**
- `createDB(): Kysely<Database>` - Creates configured DB instance
- Export `db` constant for app-wide use

#### 2. `/src/lib/db/index.ts`
```typescript
/**
 * Main database export
 * Re-exports database instance and types
 */
```

**Requirements:**
- Re-export `db` from connection.ts
- Re-export Database type from types.ts
- Re-export migration utilities

#### 3. `/src/lib/db/migrations/index.ts`
```typescript
/**
 * Migration runner utilities
 *
 * Exports:
 * - migrateToLatest(): Run all pending migrations
 * - migrationProvider: Kysely migration provider
 */
```

**Requirements:**
- Import FileMigrationProvider from Kysely
- Setup migration provider to read from migrations directory
- Create `migrateToLatest()` function
- Add error handling and logging

**Functions:**
- `migrateToLatest(): Promise<void>` - Runs all pending migrations
- `getMigrationProvider()` - Returns configured migration provider

#### 4. `/src/lib/db/types.ts`
```typescript
/**
 * Database types (auto-generated by kysely-codegen)
 * DO NOT EDIT MANUALLY
 *
 * Generated from database schema
 */
```

**Note:** This file will be auto-generated in Step 02 after schema creation

### Configuration Files

#### Update `package.json` scripts:
```json
{
  "scripts": {
    "db:migrate": "tsx src/lib/db/migrations/run.ts",
    "db:migrate:make": "kysely migrate make --dialect=sqlite",
    "db:types": "kysely-codegen --dialect=sqlite --out-file=src/lib/db/types.ts"
  }
}
```

#### Create `/src/lib/db/migrations/run.ts`
CLI script to run migrations from command line

## Business Logic Functions

### Database Connection (`/src/lib/db/connection.ts`)
- `createDB(): Kysely<Database>`
  - Creates database instance
  - Configures SQLite connection
  - Sets up dialect and driver
  - Returns typed Kysely instance

### Migration Runner (`/src/lib/db/migrations/index.ts`)
- `migrateToLatest(): Promise<void>`
  - Runs all pending migrations
  - Logs migration results
  - Handles migration errors
  - Returns migration status

- `getMigrationProvider(): FileMigrationProvider`
  - Creates migration provider
  - Configures migrations directory path
  - Returns configured provider

## Testing Requirements

### Unit Tests

#### `/src/lib/db/connection.test.ts`
- ✅ Database instance is created successfully
- ✅ Database connection can be established
- ✅ Database instance is a singleton (same instance on multiple imports)
- ✅ WAL mode is enabled
- ✅ Database can execute simple queries

#### `/src/lib/db/migrations/index.test.ts`
- ✅ Migration provider is created with correct path
- ✅ `migrateToLatest()` can be called without errors
- ✅ Migration status is logged correctly
- ✅ Migration errors are handled gracefully

### Testing Strategy
- Use in-memory SQLite for tests (`:memory:`)
- Create separate test database instance
- Clean up database connections after tests
- Mock file system for migration tests

## Acceptance Criteria

- [ ] Kysely and kysely-codegen packages installed
- [ ] Database connection file created with typed instance
- [ ] Migration system configured and working
- [ ] Migration scripts added to package.json
- [ ] Database singleton can be imported: `import { db } from '$lib/db'`
- [ ] Simple query can be executed successfully
- [ ] All unit tests passing
- [ ] Type generation script works (even with empty schema)
- [ ] Documentation includes usage examples

## Usage Example

After completion, other parts of the app should be able to use the database like this:

```typescript
import { db } from '$lib/db';

// Type-safe query
const users = await db
  .selectFrom('user')
  .selectAll()
  .execute();

// Kysely provides full type safety
const result = await db
  .insertInto('user')
  .values({
    email: 'test@example.com',
    name: 'Test User'
  })
  .execute();
```

## Notes

- Keep database connection configuration flexible for future PostgreSQL migration
- Document any SQLite-specific configurations
- Ensure proper error handling for database connection failures
- Consider connection pooling for production (may not be needed for SQLite)
- WAL mode improves concurrent read/write performance

## References

- [Kysely Documentation](https://kysely.dev/)
- [Kysely SQLite Dialect](https://kysely.dev/docs/dialects#sqlite)
- [Kysely Migrations Guide](https://kysely.dev/docs/migrations)
- [better-sqlite3 Documentation](https://github.com/WiseLibs/better-sqlite3)
